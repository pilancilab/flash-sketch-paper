from gitbud.gitbud import inject_repo_into_sys_path
inject_repo_into_sys_path()

import globals as g
from data.llm import LlmWeightsDatasetConfig
from data.synthetic import SyntheticDatasetConfig
from data.suitesparse.load import SuiteSparseDatasetConfig


ABLATION_K_SWEEP_BASE = [64, 256, 512, 1024, 2048, 4096]
ABLATION_K_SWEEP_LARGE = ABLATION_K_SWEEP_BASE


def ablation_datasets():
    """Return the datasets for ablation sweeps."""
    datasets = [
        (
            SyntheticDatasetConfig(
                name="synthetic_ls_tall_16k_1k",
                d=16384,
                n=1024,
                distribution=g.DIST_GAUSSIAN,
                seed=0,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
        (
            SyntheticDatasetConfig(
                name="synthetic_ls_tall_64k_1k",
                d=65536,
                n=1024,
                distribution=g.DIST_GAUSSIAN,
                seed=6,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
        (
            SyntheticDatasetConfig(
                name="synthetic_lr_tall_16k_1k",
                d=16384,
                n=1024,
                distribution=g.DIST_LOW_RANK,
                rank=64,
                noise=1e-5,
                seed=1,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
        (
            SyntheticDatasetConfig(
                name="synthetic_lr_tall_64k_1k",
                d=65536,
                n=1024,
                distribution=g.DIST_LOW_RANK,
                rank=64,
                noise=1e-5,
                seed=7,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
        (
            LlmWeightsDatasetConfig(
                name="gpt2_medium_weights_concat_16k_1k",
                model_name=g.LLM_MODEL_GPT2_MEDIUM,
                param_name=g.LLM_PARAM_CONCAT_LAYERS,
                submatrix_rows=16384,
                submatrix_cols=1024,
                seed=12,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
        (
            LlmWeightsDatasetConfig(
                name="gpt2_medium_weights_concat_full_64k_1k",
                model_name=g.LLM_MODEL_GPT2_MEDIUM,
                param_name=g.LLM_PARAM_CONCAT_LAYERS_FULL,
                submatrix_rows=65536,
                submatrix_cols=1024,
                seed=12,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
        (
            SuiteSparseDatasetConfig(
                group="Mittelmann",
                name="spal_004",
                submatrix_rows=16384,
                submatrix_cols=1024,
                max_dense_elems=20_000_000,
                transpose=True,
                seed=2,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
        (
            SuiteSparseDatasetConfig(
                group="Mittelmann",
                name="spal_004",
                submatrix_rows=65536,
                submatrix_cols=1024,
                max_dense_elems=80_000_000,
                transpose=True,
                seed=6,
            ),
            ABLATION_K_SWEEP_BASE,
        ),
    ]

    datasets.extend(
        [
            (
                SyntheticDatasetConfig(
                    name="synthetic_ls_tall_128k_512",
                    d=131072,
                    n=512,
                    distribution=g.DIST_GAUSSIAN,
                    seed=8,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
            (
                SyntheticDatasetConfig(
                    name="synthetic_ls_tall_256k_512",
                    d=262144,
                    n=512,
                    distribution=g.DIST_GAUSSIAN,
                    seed=3,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
            (
                SyntheticDatasetConfig(
                    name="synthetic_lr_tall_128k_512",
                    d=131072,
                    n=512,
                    distribution=g.DIST_LOW_RANK,
                    rank=64,
                    noise=1e-5,
                    seed=9,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
            (
                SyntheticDatasetConfig(
                    name="synthetic_lr_tall_256k_512",
                    d=262144,
                    n=512,
                    distribution=g.DIST_LOW_RANK,
                    rank=64,
                    noise=1e-5,
                    seed=4,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
            (
                LlmWeightsDatasetConfig(
                    name="qwen2_1p5b_weights_full_128k_512",
                    model_name=g.LLM_MODEL_QWEN2_1P5B,
                    param_name=g.LLM_PARAM_CONCAT_LAYERS_FULL,
                    submatrix_rows=131072,
                    submatrix_cols=512,
                    seed=14,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
            (
                LlmWeightsDatasetConfig(
                    name="qwen2_1p5b_weights_full_256k_512",
                    model_name=g.LLM_MODEL_QWEN2_1P5B,
                    param_name=g.LLM_PARAM_CONCAT_LAYERS_FULL,
                    submatrix_rows=262144,
                    submatrix_cols=512,
                    seed=13,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
            (
                SuiteSparseDatasetConfig(
                    group="Mittelmann",
                    name="spal_004",
                    submatrix_rows=131072,
                    submatrix_cols=512,
                    max_dense_elems=120_000_000,
                    transpose=True,
                    seed=7,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
            (
                SuiteSparseDatasetConfig(
                    group="Mittelmann",
                    name="spal_004",
                    submatrix_rows=262144,
                    submatrix_cols=512,
                    max_dense_elems=200_000_000,
                    transpose=True,
                    seed=5,
                ),
                ABLATION_K_SWEEP_LARGE,
            ),
        ]
    )

    return datasets
